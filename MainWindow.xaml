<Window x:Class="Swarm.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        mc:Ignorable="d"
        Title="Swarm" 
        Height="720" Width="1180"
        MinHeight="600" MinWidth="900"
        WindowStyle="None"
        AllowsTransparency="True"
        Background="Transparent"
        WindowStartupLocation="CenterScreen">

    <Window.Resources>
        <!-- Animations -->
        <Storyboard x:Key="FadeInAnimation">
            <DoubleAnimation Storyboard.TargetProperty="Opacity" From="0" To="1" Duration="0:0:0.3"/>
            <DoubleAnimation Storyboard.TargetProperty="(UIElement.RenderTransform).(TranslateTransform.Y)" From="20" To="0" Duration="0:0:0.3">
                <DoubleAnimation.EasingFunction>
                    <ExponentialEase EasingMode="EaseOut" Exponent="2"/>
                </DoubleAnimation.EasingFunction>
            </DoubleAnimation>
        </Storyboard>

        <Storyboard x:Key="PulseAnimation" RepeatBehavior="Forever">
            <DoubleAnimation Storyboard.TargetName="RadarPulse1" Storyboard.TargetProperty="Opacity" From="0.6" To="0" Duration="0:0:2"/>
            <DoubleAnimation Storyboard.TargetName="RadarPulse1" Storyboard.TargetProperty="(UIElement.RenderTransform).(ScaleTransform.ScaleX)" From="0.5" To="1.5" Duration="0:0:2"/>
            <DoubleAnimation Storyboard.TargetName="RadarPulse1" Storyboard.TargetProperty="(UIElement.RenderTransform).(ScaleTransform.ScaleY)" From="0.5" To="1.5" Duration="0:0:2"/>
        </Storyboard>
    </Window.Resources>

    <!-- Main Container -->
    <Border Background="{StaticResource BackgroundDarkBrush}" CornerRadius="12" BorderBrush="#30FFFFFF" BorderThickness="1">
        <Grid>
            <!-- Background Elements -->
            <Grid>
                <Ellipse Width="600" Height="600" Fill="{StaticResource GlowBrush}" Opacity="0.1" HorizontalAlignment="Right" VerticalAlignment="Bottom" Margin="0,0,-100,-100"/>
                <Ellipse Width="400" Height="400" Fill="{StaticResource GlowBrush}" Opacity="0.05" HorizontalAlignment="Left" VerticalAlignment="Top" Margin="-100,-100,0,0"/>
            </Grid>

            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/> <!-- Title Bar -->
                    <RowDefinition Height="*"/>    <!-- Content -->
                </Grid.RowDefinitions>

                <!-- ========== TITLE BAR ========== -->
                <Border Grid.Row="0" Background="Transparent" MouseLeftButtonDown="TitleBar_MouseLeftButtonDown" Height="50">
                    <Grid>
                        <!-- Logo -->
                        <StackPanel Orientation="Horizontal" VerticalAlignment="Center" Margin="24,0">
                            <Ellipse Width="12" Height="12" Fill="{StaticResource AccentPrimaryBrush}"/>
                            <Ellipse Width="12" Height="12" Fill="{StaticResource AccentSecondaryBrush}" Margin="-6,0,0,0" Opacity="0.8"/>
                            <TextBlock Text="SWARM" FontWeight="Bold" FontSize="18" Foreground="{StaticResource TextPrimaryBrush}" VerticalAlignment="Center" Margin="12,0,0,0"/>
                            <TextBlock Text="{Binding StatusText}" Foreground="{StaticResource TextSecondaryBrush}" FontSize="12" VerticalAlignment="Center" Margin="16,0,0,0"/>
                        </StackPanel>

                        <!-- Window Controls -->
                        <StackPanel Orientation="Horizontal" HorizontalAlignment="Right" Margin="0,0,16,0">
                            <Button Style="{StaticResource IconButtonStyle}" Click="SettingsButton_Click" ToolTip="Settings">
                                <Path Data="M19.14,12.94c0.04-0.3,0.06-0.61,0.06-0.94c0-0.32-0.02-0.64-0.07-0.94l2.03-1.58c0.18-0.14,0.23-0.41,0.12-0.61 l-1.92-3.32c-0.12-0.22-0.37-0.29-0.59-0.22l-2.39,0.96c-0.5-0.38-1.03-0.7-1.62-0.94L14.4,2.81c-0.04-0.24-0.24-0.41-0.48-0.41 h-3.84c-0.24,0-0.43,0.17-0.47,0.41L9.25,5.35C8.66,5.59,8.12,5.92,7.63,6.29L5.24,5.33c-0.22-0.08-0.47,0-0.59,0.22L2.74,8.87 C2.62,9.08,2.66,9.34,2.86,9.48l2.03,1.58C4.84,11.36,4.8,11.69,4.8,12s0.02,0.64,0.07,0.94l-2.03,1.58 c-0.18,0.14-0.23,0.41-0.12,0.61l1.92,3.32c0.12,0.22,0.37,0.29,0.59,0.22l2.39-0.96c0.5,0.38,1.03,0.7,1.62,0.94l0.36,2.54 c0.05,0.24,0.24,0.41,0.48,0.41h3.84c0.24,0,0.44-0.17,0.47-0.41l0.36-2.54c0.59-0.24,1.13-0.56,1.62-0.94l2.39,0.96 c0.22,0.08,0.47,0,0.59-0.22l1.92-3.32c0.12-0.22,0.07-0.47-0.12-0.61L19.14,12.94z M12,15.6c-1.98,0-3.6-1.62-3.6-3.6 s1.62-3.6,3.6-3.6s3.6,1.62,3.6,3.6S13.98,15.6,12,15.6z"
                                      Width="16" Height="16" Stretch="Uniform" Fill="{StaticResource TextSecondaryBrush}"/>
                            </Button>
                            <Button Content="─" Style="{StaticResource IconButtonStyle}" Click="MinimizeButton_Click"/>
                            <Button Content="□" Style="{StaticResource IconButtonStyle}" Click="MaximizeButton_Click"/>
                            <Button Content="✕" Style="{StaticResource IconButtonStyle}" Click="CloseButton_Click" Foreground="{StaticResource AccentDestructiveBrush}"/>
                        </StackPanel>
                    </Grid>
                </Border>

                <!-- ========== MAIN CONTENT ========== -->
                <Grid Grid.Row="1" Margin="24">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="380"/> <!-- Left Panel -->
                        <ColumnDefinition Width="24"/>  <!-- Spacer -->
                        <ColumnDefinition Width="*"/>   <!-- Right Panel -->
                    </Grid.ColumnDefinitions>

                    <!-- LEFT COLUMN -->
                    <StackPanel Grid.Column="0">
                        <!-- Nearby Devices -->
                        <Border Style="{StaticResource CardBorderStyle}" Height="300">
                            <Grid>
                                <Grid.RowDefinitions>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="*"/>
                                </Grid.RowDefinitions>

                                <!-- Header -->
                                <Grid Margin="0,0,0,16">
                                    <TextBlock Text="Nearby Devices" FontSize="16" FontWeight="SemiBold" Foreground="{StaticResource TextPrimaryBrush}"/>
                                    <Grid HorizontalAlignment="Right">
                                        <Ellipse x:Name="RadarPulse1" Width="20" Height="20" Stroke="{StaticResource AccentPrimaryBrush}" StrokeThickness="1.5" RenderTransformOrigin="0.5,0.5">
                                            <Ellipse.RenderTransform>
                                                <ScaleTransform/>
                                            </Ellipse.RenderTransform>
                                        </Ellipse>
                                        <Ellipse Width="6" Height="6" Fill="{StaticResource AccentPrimaryBrush}" HorizontalAlignment="Center" VerticalAlignment="Center"/>
                                    </Grid>
                                </Grid>

                                <!-- List -->
                                <ListBox Grid.Row="1" ItemsSource="{Binding Peers}" Style="{StaticResource PeerListBoxStyle}"
                                         ItemContainerStyle="{StaticResource PeerListBoxItemStyle}"
                                         SelectionChanged="PeerListBox_SelectionChanged">
                                    <ListBox.ItemTemplate>
                                        <DataTemplate>
                                            <Grid>
                                                <Grid.ColumnDefinitions>
                                                    <ColumnDefinition Width="Auto"/>
                                                    <ColumnDefinition Width="*"/>
                                                </Grid.ColumnDefinitions>
                                                <Ellipse Width="8" Height="8" Fill="{StaticResource StatusOnlineBrush}" VerticalAlignment="Center" Margin="0,0,12,0"/>
                                                <StackPanel Grid.Column="1">
                                                    <TextBlock Text="{Binding Name}" FontWeight="Medium" Foreground="{StaticResource TextPrimaryBrush}"/>
                                                    <TextBlock Text="{Binding IpAddress}" FontSize="11" Foreground="{StaticResource TextSecondaryBrush}"/>
                                                </StackPanel>
                                            </Grid>
                                        </DataTemplate>
                                    </ListBox.ItemTemplate>
                                </ListBox>

                                <!-- Empty State -->
                                <StackPanel Grid.Row="1" Visibility="{Binding EmptyPeersVisibility}" VerticalAlignment="Center" HorizontalAlignment="Center" Opacity="0.6">
                                    <TextBlock Text="Searching..." Foreground="{StaticResource TextMutedBrush}" HorizontalAlignment="Center"/>
                                </StackPanel>
                            </Grid>
                        </Border>

                        <!-- Synced Folder -->
                        <Border Style="{StaticResource CardBorderStyle}" Margin="0,24,0,0">
                            <Grid>
                                <StackPanel>
                                    <TextBlock Text="Synced Folder" FontSize="16" FontWeight="SemiBold" Foreground="{StaticResource TextPrimaryBrush}" Margin="0,0,0,16"/>
                                    
                                    <Border Background="#10ffffff" CornerRadius="8" Padding="12">
                                        <Grid>
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="Auto"/>
                                                <ColumnDefinition Width="*"/>
                                                <ColumnDefinition Width="Auto"/>
                                            </Grid.ColumnDefinitions>
                                            <Path Data="M10 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2h-8l-2-2z"
                                                  Width="16" Height="16" Stretch="Uniform" Fill="{StaticResource AccentSecondaryBrush}" Margin="0,0,12,0"/>
                                            <TextBlock Grid.Column="1" Text="{Binding SyncFolderDisplayPath}" Foreground="{StaticResource TextSecondaryBrush}" 
                                                       VerticalAlignment="Center" TextTrimming="CharacterEllipsis"/>
                                            <Button Grid.Column="2" Content="Change" Style="{StaticResource SecondaryButtonStyle}" 
                                                    Padding="8,4" FontSize="11" Margin="8,0,0,0" Command="{Binding ChangeSyncFolderCommand}"/>
                                        </Grid>
                                    </Border>

                                    <!-- Progress -->
                                    <StackPanel Margin="0,16,0,0" Visibility="{Binding SyncProgressVisibility}">
                                        <Grid Margin="0,0,0,8">
                                            <TextBlock Text="{Binding SyncStatusText}" FontSize="12" Foreground="{StaticResource TextSecondaryBrush}"/>
                                            <TextBlock Text="{Binding SyncProgressValue, StringFormat={}{0:0}%}" HorizontalAlignment="Right" FontSize="12" Foreground="{StaticResource AccentPrimaryBrush}"/>
                                        </Grid>
                                        <ProgressBar Value="{Binding SyncProgressValue, Mode=OneWay}" Style="{StaticResource TransferProgressBarStyle}"/>
                                    </StackPanel>

                                    <!-- Actions -->
                                    <UniformGrid Rows="1" Columns="2" Margin="0,24,0,0">
                                        <Button Content="Open Folder" Style="{StaticResource SecondaryButtonStyle}" Command="{Binding OpenSyncFolderCommand}" Margin="0,0,4,0"/>
                                        <Button Content="History" Style="{StaticResource SecondaryButtonStyle}" Command="{Binding OpenVersionHistoryCommand}" Margin="4,0,0,0"/>
                                    </UniformGrid>
                                </StackPanel>
                            </Grid>
                        </Border>
                    </StackPanel>

                    <!-- RIGHT COLUMN -->
                    <Grid Grid.Column="2">
                        <Grid.RowDefinitions>
                            <RowDefinition Height="*"/>
                            <RowDefinition Height="24"/>
                            <RowDefinition Height="Auto" MinHeight="250"/>
                        </Grid.RowDefinitions>

                        <!-- Drop Zone -->
                        <Border x:Name="DropZoneBorder" Grid.Row="0" Style="{StaticResource CardBorderStyle}"
                                AllowDrop="True" DragEnter="DropZone_DragEnter" DragLeave="DropZone_DragLeave" Drop="DropZone_Drop"
                                BorderBrush="#402dd4bf" BorderThickness="2" Background="{StaticResource BackgroundGlassBrush}">
                            <Grid>
                                <!-- Dashed Effect using Rectangle -->
                                <Rectangle Stroke="{StaticResource AccentPrimaryBrush}" StrokeThickness="2" StrokeDashArray="4 4" RadiusX="12" RadiusY="12" Opacity="0.3" Margin="4"/>
                                
                                <StackPanel VerticalAlignment="Center" HorizontalAlignment="Center">
                                    <Border Width="80" Height="80" CornerRadius="40" Background="#102dd4bf" Margin="0,0,0,24">
                                        <Path x:Name="DropZoneIcon" Data="M19.35 10.04C18.67 6.59 15.64 4 12 4 9.11 4 6.6 5.64 5.35 8.04 2.34 8.36 0 10.91 0 14c0 3.31 2.69 6 6 6h13c2.76 0 5-2.24 5-5 0-2.64-2.05-4.78-4.65-4.96zM14 13v4h-4v-4H7l5-5 5 5h-3z"
                                              Width="32" Height="32" Stretch="Uniform" Fill="{StaticResource AccentPrimaryBrush}" HorizontalAlignment="Center" VerticalAlignment="Center"/>
                                    </Border>
                                    <TextBlock x:Name="DropZoneTitle" Text="Send Files" FontSize="24" FontWeight="Bold" Foreground="{StaticResource TextPrimaryBrush}" HorizontalAlignment="Center"/>
                                    <TextBlock Text="Drop files here or click to browse" FontSize="14" Foreground="{StaticResource TextSecondaryBrush}" HorizontalAlignment="Center" Margin="0,8,0,24"/>
                                    <Button Content="Browse Files" Style="{StaticResource PrimaryButtonStyle}" Click="BrowseButton_Click" HorizontalAlignment="Center" Width="160"/>
                                    <TextBlock Text="{Binding SelectedPeerText}" Foreground="{StaticResource AccentPrimaryBrush}" HorizontalAlignment="Center" Margin="0,16,0,0" FontWeight="Medium"/>
                                </StackPanel>
                            </Grid>
                        </Border>

                        <!-- Transfers -->
                        <Border Grid.Row="2" Style="{StaticResource CardBorderStyle}">
                            <Grid>
                                <TextBlock Text="Active Transfers" FontSize="16" FontWeight="SemiBold" Foreground="{StaticResource TextPrimaryBrush}" Margin="0,0,0,16"/>
                                <ListBox Grid.Row="1" ItemsSource="{Binding Transfers}" Style="{StaticResource PeerListBoxStyle}" Margin="0,32,0,0" MaxHeight="200">
                                    <ListBox.ItemTemplate>
                                        <DataTemplate>
                                            <Grid Margin="0,4">
                                                <Grid.ColumnDefinitions>
                                                    <ColumnDefinition Width="*"/>
                                                    <ColumnDefinition Width="Auto"/>
                                                </Grid.ColumnDefinitions>
                                                <Grid.RowDefinitions>
                                                    <RowDefinition Height="Auto"/>
                                                    <RowDefinition Height="Auto"/>
                                                </Grid.RowDefinitions>

                                                <StackPanel Orientation="Horizontal">
                                                    <Path Data="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zm2 16H8v-2h8v2zm0-4H8v-2h8v2zm-3-5V3.5L18.5 9H13z"
                                                          Width="12" Height="12" Stretch="Uniform" Fill="{StaticResource TextSecondaryBrush}" Margin="0,0,8,0" VerticalAlignment="Center"/>
                                                    <TextBlock Text="{Binding FileName}" Foreground="{StaticResource TextPrimaryBrush}" FontWeight="Medium"/>
                                                </StackPanel>
                                                
                                                <TextBlock Grid.Column="1" Text="{Binding SpeedDisplay}" Foreground="{StaticResource TextSecondaryBrush}" FontSize="12"/>
                                                
                                                <ProgressBar Grid.Row="1" Grid.ColumnSpan="2" Value="{Binding Progress, Mode=OneWay}" 
                                                             Style="{StaticResource TransferProgressBarStyle}" Margin="0,8,0,0"/>
                                            </Grid>
                                        </DataTemplate>
                                    </ListBox.ItemTemplate>
                                </ListBox>
                                
                                <TextBlock Text="No active transfers" Visibility="{Binding EmptyTransfersVisibility}" 
                                           Foreground="{StaticResource TextMutedBrush}" VerticalAlignment="Center" HorizontalAlignment="Center" Margin="0,32,0,0"/>
                            </Grid>
                        </Border>
                    </Grid>
                </Grid>
            </Grid>

            <!-- ========== OVERLAYS ========== -->
            
            <!-- Modal Overlay -->
            <Grid x:Name="ModalOverlay" Visibility="Collapsed" Background="#CC000000" IsHitTestVisible="True">
                 
                 <!-- Trust Device Dialog -->
                 <Border x:Name="TrustDeviceDialog" Background="{StaticResource BackgroundCardBrush}" CornerRadius="16" 
                         HorizontalAlignment="Center" VerticalAlignment="Center" 
                         Padding="32" Width="420" Effect="{StaticResource CardShadow}" Visibility="Collapsed">
                     <StackPanel>
                         <Ellipse Width="48" Height="48" Fill="{StaticResource AccentPrimaryBrush}" Margin="0,0,0,16"/>
                         <TextBlock Text="New Device Detected" FontSize="20" FontWeight="Bold" Foreground="{StaticResource TextPrimaryBrush}" HorizontalAlignment="Center" Margin="0,0,0,8"/>
                         <TextBlock x:Name="TrustDeviceName" Text="Device Name" FontSize="16" Foreground="{StaticResource TextSecondaryBrush}" HorizontalAlignment="Center" Margin="0,0,0,24"/>
                         
                         <Border Background="{StaticResource BackgroundMediumBrush}" CornerRadius="8" Padding="16" Margin="0,0,0,24">
                             <StackPanel>
                                 <TextBlock Text="Device Fingerprint" FontSize="11" Foreground="{StaticResource TextMutedBrush}" Margin="0,0,0,4"/>
                                 <TextBlock x:Name="DeviceFingerprint" Text="ABCD-1234..." FontFamily="Consolas" FontSize="14" Foreground="{StaticResource TextPrimaryBrush}" TextWrapping="Wrap"/>
                                 
                                 <TextBlock Text="Your Fingerprint" FontSize="11" Foreground="{StaticResource TextMutedBrush}" Margin="0,16,0,4"/>
                                 <TextBlock x:Name="MyFingerprint" Text="WXYZ-9876..." FontFamily="Consolas" FontSize="14" Foreground="{StaticResource TextPrimaryBrush}" TextWrapping="Wrap"/>
                             </StackPanel>
                         </Border>
                         
                         <Grid>
                             <Grid.ColumnDefinitions>
                                 <ColumnDefinition Width="*"/>
                                 <ColumnDefinition Width="16"/>
                                 <ColumnDefinition Width="*"/>
                             </Grid.ColumnDefinitions>
                             <Button Content="Reject" Style="{StaticResource SecondaryButtonStyle}" Click="RejectTrust_Click"/>
                             <Button Grid.Column="2" Content="Trust Device" Style="{StaticResource PrimaryButtonStyle}" Click="AcceptTrust_Click"/>
                         </Grid>
                     </StackPanel>
                 </Border>

                 <!-- Incoming File Dialog -->
                 <Border x:Name="IncomingFileDialog" Background="{StaticResource BackgroundCardBrush}" CornerRadius="16" 
                         HorizontalAlignment="Center" VerticalAlignment="Center" 
                         Padding="32" Width="400" Effect="{StaticResource CardShadow}" Visibility="Collapsed">
                     <StackPanel>
                         <Path Data="M19.35 10.04C18.67 6.59 15.64 4 12 4 9.11 4 6.6 5.64 5.35 8.04 2.34 8.36 0 10.91 0 14c0 3.31 2.69 6 6 6h13c2.76 0 5-2.24 5-5 0-2.64-2.05-4.78-4.65-4.96zM14 13v4h-4v-4H7l5-5 5 5h-3z"
                               Width="48" Height="48" Stretch="Uniform" Fill="{StaticResource AccentSecondaryBrush}" Margin="0,0,0,16" HorizontalAlignment="Center"/>
                         
                         <TextBlock Text="Incoming File" FontSize="20" FontWeight="Bold" Foreground="{StaticResource TextPrimaryBrush}" HorizontalAlignment="Center" Margin="0,0,0,8"/>
                         <TextBlock x:Name="IncomingSender" Text="from Mikey's PC" FontSize="14" Foreground="{StaticResource TextSecondaryBrush}" HorizontalAlignment="Center" Margin="0,0,0,24"/>
                         
                         <Border Background="{StaticResource BackgroundMediumBrush}" CornerRadius="8" Padding="16" Margin="0,0,0,24">
                             <StackPanel>
                                 <TextBlock x:Name="IncomingFileName" Text="presentation.pdf" FontWeight="SemiBold" Foreground="{StaticResource TextPrimaryBrush}" TextTrimming="CharacterEllipsis"/>
                                 <TextBlock x:Name="IncomingFileSize" Text="2.4 MB" FontSize="12" Foreground="{StaticResource TextSecondaryBrush}" Margin="0,4,0,0"/>
                             </StackPanel>
                         </Border>
                         
                         <Grid>
                             <Grid.ColumnDefinitions>
                                 <ColumnDefinition Width="*"/>
                                 <ColumnDefinition Width="16"/>
                                 <ColumnDefinition Width="*"/>
                             </Grid.ColumnDefinitions>
                             <Button Content="Decline" Style="{StaticResource SecondaryButtonStyle}" Click="RejectFile_Click"/>
                             <Button Grid.Column="2" Content="Accept" Style="{StaticResource PrimaryButtonStyle}" Click="AcceptFile_Click"/>
                         </Grid>
                     </StackPanel>
                 </Border>
            </Grid>
            
            <!-- Notification Overlay -->
            <StackPanel x:Name="NotificationStack" VerticalAlignment="Bottom" HorizontalAlignment="Right" Margin="24" Width="320" IsHitTestVisible="False"/>
            
        </Grid>
    </Border>
</Window>
